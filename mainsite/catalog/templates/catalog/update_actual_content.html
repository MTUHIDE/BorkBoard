{% comment %} Required additional vars to pass in: default_image_target,
because I don't understand what's going on with 'load static' {% endcomment %}

  <!-----------------------------------
  Catalog Form
  ----------------------------------->
   <div role="tabpanel" class="tab-pane active" id="ctlg">
     <div class='row justify-content-center'>
         <div class='col-lg-5' style='margin: 10px;'>
            <!-- Catalog Form Errors -->

            <form role="form" method="post" enctype="multipart/form-data" style='border: 2xp;' onsubmit="ItemInputSubmit()">
                {% csrf_token %}

                {% with form=catalog_form %}
                    {% include "profanity_check/errors.html" %}
                {% endwith %}

                <input type="hidden" name="submission_type" value="ctlg">
                <hr size="4">
                {{ catalog_form.as_p}}
                <hr size="4" >
                <div class="container" id="blahblah">

                </div>
                <hr size="4" >
                <button type="submit" class="btn btn-primary husky-button-light" id="btnRealButton">Submit</button>
            </form>

            <!-- General Form Formatting -->
            {% for field in catalog_form %}
              <script type="text/javascript">
                document.getElementById("{{field.id_for_label}}").classList.add('form-control');
              </script>
            {% endfor %}

            <script type="text/javascript">
              document.getElementById("id_item_picture").classList.add('file-field');
              document.getElementById("id_item_picture").style.backgroundColor = 'transparent';
              document.getElementById("id_item_picture").style.border = 'transparent';
              document.getElementById("id_item_picture").style.color = '#a6b1b7';
              document.getElementById("id_item_picture").style.padding = '0px';
            </script>

            <!-- Highlight Fields -->
            {% if catalog_form.errors %}
              {% for field in catalog_form %}
                  {% if field.errors %}
                    <script type="text/javascript">
                      document.getElementById("{{field.id_for_label}}").classList.add('is-invalid');
                    </script>
                  {% else %}
                    <script type="text/javascript">
                      document.getElementById("{{field.id_for_label}}").classList.add('is-valid');
                    </script>
                  {% endif %}
              {% endfor %}
            {% endif %}
         </div>
     </div>
   </div>

<!-- Used to prevent multiple submits -->
<script type="text/javascript">
  function ItemInputSubmit() {
    document.getElementById("btnRealButton").disabled = true;
  }
</script>






<template id="pic_upload_template">
    <div class="row">
        <div class="col-md-2">
            <div style="height: 100%;  display: flex; flex-direction: column; flex-flow: column noWrap; justify-content: space-between; align-items: stretch;">
                <button class="up_button" style="display: block;">↑</button>
                <button class="delete_button">X</button>
                <button class="down_button" style="display: block;">↓</button>
            </div>
        </div>

        <div class="col-md-5">
            <img height="200" width="200" src= {{ default_image_target }} >
        </div>

        <div class="col-md-5">
            <label for="id_curr_picture">Picture:
                <input type="file" name="curr_picture" accept="image/*" required="" class="form-control">
            </label>

        </div>
    </div>
</template>

<template id="pic_upload_intermediate_template">
    <div class="row">
        <div class="col-md-4">
            <button class="add_button" style="display: block;">+</button>
        </div>
    </div>
</template>

<script type="text/javascript">

    var table = null; //document.getElementById("blahblah");
    var templ = null; //document.getElementById("pic_upload_template");
    var inter = null; //document.getElementById("pic_upload_intermediate_template");


    function getRowFromButton_3(el) {
        return el.parentNode.parentNode.parentNode;
    };
    function getRowFromButton_I(el) {
        return el.parentNode.parentNode;
    };
    /*function resetEnablers() {
        for(let i = 0; i < table.children.length; ++i ) {
            table.children[i].querySelector(".up_button").enabled = true;
            table.children[i].querySelector(".down_button").enabled = true;
        }
        table.children[0].querySelector(".up_button").enabled = false;
        table.children[table.children.length - 1].querySelector(".down_button").enabled = false;
    };*/


    function constructRow() {
        let clone = templ.content.cloneNode(true);

        clone.querySelector(".up_button").onclick = up_func;
        clone.querySelector(".delete_button").onclick = delete_func;
        clone.querySelector(".down_button").onclick = down_func;

        clone.querySelector("input[name='curr_picture']").onchange = input_func;

        return clone;
    };

    function constructIntermediate() {
        let clone = inter.content.cloneNode(true);
        clone.querySelector(".add_button").onclick = add_func;
        return clone;
    };


    function up_func() {
        let myRow = getRowFromButton_3(this);
        prev = myRow.previousElementSibling.previousElementSibling;
        if(prev == null) return;
        parent = myRow.parentElement;
        parent.removeChild(myRow);
        parent.insertBefore(myRow, prev.previousElementSibling);
    };

    function delete_func() {
        let myRow = getRowFromButton_3(this);
        myRow.parentNode.removeChild(myRow.previousElementSibling);    // remove the intermediate
        myRow.parentNode.removeChild(myRow);
    };

    function down_func() {
        let myRow = getRowFromButton_3(this);
        next = myRow.nextElementSibling.nextElementSibling;
        if( next == null) return;
        parent = myRow.parentElement;
        parent.removeChild(myRow);
        parent.insertBefore(myRow, next.nextElementSibling);
    };

    function add_func() {
        let myInt = getRowFromButton_I(this);

        let clone_i = constructIntermediate();
        myInt.parentElement.insertBefore(clone_i, myInt);
        let clone_r = constructRow();
        myInt.parentElement.insertBefore(clone_r, myInt);
    };

    function input_func() {
        let myRow = this.parentNode.parentNode.parentNode;

        var reader = new FileReader();
        reader.onload = function(e) {
            myRow.querySelector("img").src = e.target.result;
        };
        reader.readAsDataURL(this.files[0]);
    };


    function reset() {
        table.innerHTML = '';
        let clone = constructIntermediate();
        table.appendChild(clone);
    {% for pic in catalog_form.instance.pictures.all %}

        clone = constructRow();
        clone.querySelector("img").src = "{{ pic.picture.url }}";
        table.appendChild(clone);
        clone = constructIntermediate();
        table.appendChild(clone);
    {% endfor %}
    };

    document.addEventListener("DOMContentLoaded", function() {
        table = document.getElementById("blahblah");
        templ = document.getElementById("pic_upload_template");
        inter = document.getElementById("pic_upload_intermediate_template");

        reset();
    });
</script>
