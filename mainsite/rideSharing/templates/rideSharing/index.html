{% extends 'base.html' %}
{% block content %}

<div class="row">
  <!--Aligns all the contents of the side bar to the cetner, and fixes the size of the col the side bar in in -->
  <div class="col align-center" style="-ms-flex: 0 0 250px; flex: 0 0 250px;">
    <!--Fixes the size of the side bar so it doent grow or shink. The width is 10 px less so then there margin between the start of the rides. -->
  <div style="text-align: center;background-color: black; height: 100%;width:240px; position: fixed; top: 50px; ">
      <h1 class="my-4" style="color: #ffcd00; text-align: center;">Ride Sharing</h1>
      <div style="display: inline-block;">
				<!--filters on sidebar-->
        {% for filter in filters %}
          {% if not curFilters %}
            <form action="/ridesharing/filter/" method="get">
          {% elif filter.category_name in curFilters %}
            <form action="/ridesharing/filter/">
          {% else %}
            <form action="/ridesharing/filter/">
          {% endif %}
          {% if filter.category_name in curFilters %}
          <button type="submit" name="filter" value="{{filter.category_name}}" class="btn btn-outline-warning" style="width: 100%; margin-bottom: 20px; background-color: #ffc107; color: black;">{{filter.category_name}}</button>
          {% else %}
          <button type="submit" name="filter" value="{{filter.category_name}}" class="btn btn-outline-warning" style="width: 100%; margin-bottom: 20px;">{{filter.category_name}}</button>
          {% endif %}
           </form>
        {% endfor %}
        <a type="button" class="btn btn-outline-warning" style="width: 100%; margin-bottom: 20px;" href="{% url 'rideSharing:index' %}"">Clear Filters</a>
      </div>
    </div>
  </div>


    <!-- /.col-lg-3 -->
    <div class="col" style="position: static;">


      {% if failed_search %}
        <div style="background-color: black; border: 2px solid black; border-spacing: 10px; text-align: center; margin-bottom: 20px; margin-top: 10px;">
            <h1 style="color: #ffcd00; margin-top: 3px; margin-bottom: 1.5px;">Oops!</h1>
            <h6 style="color: #ffcd00; margin-top: 1.5px; margin-bottom: 3px;">

              {% if failed_search == 'FilterFail' %}
              Looks like no rides have been uploaded for that category. But here are some recently-uploaded rides instead!
              {% elif failed_search == 'PageNotFoundFail' %}
              Looks like that ride couldn't be found. But here are some recently-uploaded rides instead!
              {% elif failed_search == 'SearchFail' %}
              Looks like no rides could be found for your search. But here are some recently-uploaded rides instead!
              {% else %}
              Looks like something went wrong. Please contact MTU HuskyHunt if this error persists.
              {% endif %}

            </h6>
        </div>
      {% endif %}
      <!-- -->

      <head>
      	<title>Ridesharing</title>
      </head>

      {% if search %}
      <div class="row">
          <div class="col-1"></div>
          <div class="col-3">
              <a href="{% url 'rideSharing:index' %}" class="btn btn-light">Reset Search</a>
          </div>
          <div class="col-3" style="color: #ffcd00;">
              You searched for:
              <br>{{ search }}
          </div>
          <div class="col-5"></div>
      </div>
      {% endif %}

      <br>

      <div id="primary_map" name="primary_map" style="height: 300px" ></div>

      <br>

        <div class="row">
            {% if rides %}
            {% for ride in rides %}
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="card h-100 husky-card"  style="width: auto; cursor: pointer;" data-toggle="modal" data-target="#rideModal{{ride.pk}}">
                    <div class="card-body">
                        <h4 class="card-title" style="color: white;">
                            <div style="width: auto; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; color: white; text-align: center; line-height: normal;">
                                {{ ride.destination_city }},&nbsp{{ ride.destination_state }}
                            </div>
                        </h4>
                </div>
                <div class="card-footer husky-card-foot"> <!--black-->
                    <div style="text-align: center; width: auto;">
                        <h5 class="card-text" style="color: #ffcd00;">{{ ride.first_name }}</h5>
                    </div>
                </div>
            </div>
            <!-- Modal -->
            <div id="rideModal{{ride.pk}}" class="modal fade" role="dialog">
              <div class="modal-dialog modal-lg">

                <!-- Modal content-->
                <div class="modal-content" style="background-color: #1c1c21;">
                  <div class="modal-header" style="background-color:black;"> <!-- style="justify-content:center;" this centers title in modal-->
                    <h4 class="" style="color:#ffcd00;">{{ ride.destination_city }},&nbsp{{ ride.destination_state }}</h4>
                    {% if ride.round_trip %}
                    <h6 class="text-success" style="float:right;">This ride is a round trip!</h6>
                    {% else %}
                    <h6 class="text-danger" style="float:right;">This ride is not a round trip!</h6>
                    {% endif %}
                  </div>
                  <div class="modal-body">
                    <div class="row">

                        <div class="col-lg-6">
                          <label class="label">Basic Information</label>
                          <hr style="margin-bottom: 1%;margin-top: 1%;">
                          <h6>Start: {{ ride.start_city }} {{ ride.start_state }}  {{ ride.start_zipcode }}</h6>
                          <h6>Destination: <span id="destSpan_destination_city_{{ ride.pk }}">{{ ride.destination_city }}</span> <span id="destSpan_destination_state_{{ ride.pk }}">{{ ride.destination_state }}</span> <span id="destSpan_destination_zipcode_{{ ride.pk }}">{{ ride.destination_zipcode }}</span></h6>
                          <h6>Leaving Date: {{ ride.date_leaving }}</h6> <span id="destSpan_destination_coordinates_lat_{{ ride.pk }}" hidden=true>{{ ride.destination_coordinates_lat}}</span><span id="destSpan_destination_coordinates_lon_{{ ride.pk }}" hidden=true>{{ ride.destination_coordinates_lon}}</span>
                          <br>

                          {% if ride.round_trip %}
                          <label class="label">Round trip Information</label>
                          <hr style="margin-bottom: 1%;margin-top: 1%;">

                          <h6>Return Date: {{ ride.return_date }}</h6>
                          <br>
                          {% endif %}

                          <label class="label">Travel Information</label>
                          <hr style="margin-bottom: 1%;margin-top: 1%;">
                          <h6>Driver: {{ ride.first_name }}</h6>
                          <h6>Spots: {{ ride.spots }}</h6>
                          <h6>Price: ${{ ride.price }}</h6>
                          <h6>Notes: {{ ride.notes }}</h6>
                          <br>
                          <div class="text-right">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Send</button>
                          </div>
                        </div>

                        <div class="col-lg-6">
                            <div id="mapid_{{ride.pk}}" name="mapid" style="height: 300px" ></div>
                        </div>

                      </div>
                  </div>
                </div>

              </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    {% if items.paginator.num_pages > 1 %}
    <div class="pagination">
        <span class="step-links">
            {% if items.has_previous %}
            <a href="?page=1">&laquo; first</a>
            <a href="?page={{ items.previous_page_number }}">previous</a>
            {% endif %}

            <span class="current">
                Page {{ items.number }} of {{ items.paginator.num_pages }}.
            </span>

            {% if items.has_next %}
            <a href="?page={{ items.next_page_number }}">next</a>
            <a href="?page={{ items.paginator.num_pages }}">last &raquo;</a>
            {% endif %}
        </span>
    </div>
    {% endif %}

    <!-- /.row -->
</div>
<!-- /.col-lg-9 -->
</div>

<script>

var access_token = 'pk.eyJ1IjoiY3NjaHdhIiwiYSI6ImNrNjZxdmdsYTE5MGUzbG84Z3N1dTUzOTcifQ.DKfzMNPM0XvkkwJ-nLQDHg'

function createMap(element_id) {
    // Create the map object for each ticket
    let mymap = L.map(element_id, { renderer: L.svg({ padding: 2 }) } );
    let tileLayuer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        accessToken: access_token
    }); // Note for longer-term changes: to limit requests, this should really by on request and/or cache results
    tileLayuer.addTo(mymap);

    return mymap;
};

var primaryMap = createMap("primary_map");
primaryMap.setView([43.597778, -84.7675], 6);


var map_dict = {}

document.getElementsByName("mapid").forEach(element => {

    let mymap = createMap(element.id);

    // Store so the object can be accessed later; set size/location on modal being brought up
    let ride_pk = element.id.substring(6);
    map_dict[ride_pk] = mymap;

    $('#rideModal' + ride_pk).on("shown.bs.modal", function() {
        let mymap = map_dict[ride_pk];
        mymap.setView([46.6275, -85.0375 ], 6);
        // Incidentally, the above bit is why I needed access to jQuery; apparently the event's not exposed in vanilla
        mymap.invalidateSize();
    });

    let destination_city = document.getElementById('destSpan_destination_city_' + ride_pk).innerHTML.trim();
    let destination_state = document.getElementById('destSpan_destination_state_' + ride_pk).innerHTML.trim();
    let destination_zipcode = document.getElementById('destSpan_destination_zipcode_' + ride_pk).innerHTML.trim();
    let destination_coordinates_lat = document.getElementById("destSpan_destination_coordinates_lat_" + ride_pk).innerHTML.trim();
    let destination_coordinates_lon = document.getElementById("destSpan_destination_coordinates_lon_" + ride_pk).innerHTML.trim();

    let starting_coord = [ 47.117222, -88.5625 ];
    let ending_coord = [destination_coordinates_lat, destination_coordinates_lon];

    // Add a marker to the primary_map for the ending location

    let marker = L.marker(ending_coord).bindPopup(
        ('\
            Search for rides near:<br>\
            <a href="http://localhost:8000/ridesharing/search/?search=[[1]]" class="btn btn-primary">[[2]]</a>\
        ')
        .replace("[[1]]", encodeURIComponent("[ " + destination_coordinates_lat + " , " + destination_coordinates_lon + " ]" ) )
        .replace("[[2]]", destination_city.trim())
    ).addTo(primaryMap);

    // Request the route from Mapbox servers
    let route_url = "https://api.mapbox.com/directions/v5/mapbox/driving/"
    + starting_coord[1] + "," + starting_coord[0] + ";"
    + ending_coord[1] + "," + ending_coord[0]
    + "?geometries=geojson&access_token="
    + access_token;

    let route_req = new XMLHttpRequest();
    route_req.open('GET', route_url, true);
    route_req.onload = function() {
        let json = JSON.parse(route_req.response);
        let data = json.routes[0];
        let route = data.geometry.coordinates;

        let geojsonFeature = {
            "type": "Feature",
            "properties": {
                "name": "Ridesharing trip"
            },
            "geometry": {
              type: 'LineString',
              coordinates: route
            }
        }

        L.geoJSON(geojsonFeature, {
            style: {
                color: 'red',
                weight: 4
            }
        }).addTo(mymap);
    };
    route_req.send();
});

function modalcard_onclick(ride_pk) {

}

</script>


{% endblock %}
